<!doctype html>
<html lang="en">
    {% load static %}
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="{% static 'assets/css/profile.css' %}">

    <title>Profile Page</title>
  </head>
  <body>
    <div class="container">

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="main-breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'guide' %}">Guide to Use</a></li>
            <li class="breadcrumb-item active" aria-current="page">Profile Settings</li>
          </ol>
        </nav>
        <!-- /Breadcrumb -->
  
        <div class="row gutters-sm">
          <div class="col-md-4 d-none d-md-block">
            <div class="card">
              <div class="card-body">
                <nav class="nav flex-column nav-pills nav-gap-y-1">

                  <a href="#profile" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded active">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user mr-2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>Profile Information
                  </a>

                  <a href="#security" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield mr-2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>Change Password
                  </a>

                  <a href="#account" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
                    <svg  width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2 mr-2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m6 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Delete Account
                </a>

              <a href="#" onclick="confirmLogout(event)" class="nav-item nav-link has-icon nav-link-faded">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out mr-2">
                  <path d="M16 17l5-5-5-5"></path>
                  <line x1="3" y1="12" x2="21" y2="12"></line>
              </svg>
              Logout
              </a>
                </nav>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-header border-bottom mb-3 d-flex d-md-none">
                <ul class="nav nav-tabs card-header-tabs nav-gap-x-1" role="tablist">
                  <li class="nav-item">
                    <a href="#profile" data-toggle="tab" class="nav-link has-icon active"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a>
                  </li>
                  <li class="nav-item">
                    <a href="#account" data-toggle="tab" class="nav-link has-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></a>
                  </li>
                  <li class="nav-item">
                    <a href="#security" data-toggle="tab" class="nav-link has-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></a>
                  </li>
                 
                
                </ul>
              </div>
              <div class="card-body tab-content">
                <div class="tab-pane active" id="profile">
                    <h6>YOUR ACCOUNT DETAILS</h6>
                    <hr>
                    <form id="profile-form">
                        {% csrf_token %}
                        <input type="hidden" name="token" value="{{ request.user.auth_token.key }}">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" class="form-control username" name="username" placeholder="Enter username" value="{{user.username}}">
                        </div>
                        <div class="form-group row">
                            <div class="col">
                                <label for="firstName">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="first_name" placeholder="Enter first name" value="{{user.first_name}}">
                            </div>
                            <div class="col">
                                <label for="lastName">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="last_name" placeholder="Enter last name" value="{{user.last_name}}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" value="{{user.email}}">
                            </div>
                            <div class="col">
                                <label for="phone">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone_number" placeholder="Enter phone number" value="{{user.phone_number}}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col">
                                <label for="address">Address</label>
                                <input type="text" class="form-control" id="address" name="address" placeholder="Enter address" value="{{user.address}}">
                            </div>
                            <div class="col">
                                <label for="gender">Gender</label>
                                <select class="form-control" id="gender" name="gender">
                                    <option value="Male" {% if user.gender == "Male" %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if user.gender == "Female" %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if user.gender == "Other" %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group small text-muted">
                            All of the fields on this page are optional and can be deleted at any time, and by filling them out, you're giving us consent to share this data wherever your user profile appears.
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="reset" class="btn btn-light">Reset Changes</button>
                    </form>
                </div>
                <div class="tab-pane" id="account">
                  <h6>ACCOUNT SETTINGS</h6>
                  <hr>
                  <form>
                    <div class="form-group">

                      <label for="username">Username</label>

                      <input type="text" class="form-control username" name="username" placeholder="Enter username" value="{{user.username}}">

                      <small id="usernameHelp" class="form-text text-muted">After changing your username, your old username becomes available for anyone else to claim.</small>
                    </div>
                    <hr>
                    <div class="form-group">
                      <label class="d-block text-danger">Delete Account</label>
                      <p class="text-muted font-size-sm">Once you delete your account, there is no going back. Please be certain.</p>
                    </div>
                    <button class="btn btn-danger" type="button" id="deleteAccountButton">Delete Account</button>
                  </form>
                </div>
                <div class="tab-pane" id="security">
                  <h6>PASSWORD SETTINGS</h6>
                  <hr>
                  <form id="passwordChangeForm">
                      <div class="form-group">
                          <label class="d-block">Change Password</label>
                          <input type="password" name="old_password" class="form-control" placeholder="Enter your old password" required>
                          <input type="password" name="new_password1" class="form-control mt-1" placeholder="New password" required>
                          <input type="password" name="new_password2" class="form-control mt-1" placeholder="Confirm new password" required>
                      </div>
                      <label class="d-block">Confirm Changing Password</label>
                      <button type="submit" class="btn btn-info">Change Password</button>
                      <p class="small text-muted mt-2">Please Put the Strong Password.</p>
                  </form>
                  <hr>
                </div>  
      </div>
  </body>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>

    // store the initial form data when the page loads
    let initialFormData = new FormData(document.getElementById('profile-form'));

    document.getElementById('profile-form').addEventListener('submit', function(event) {

        // prevent form submission
        event.preventDefault();
        
        const currentFormData = new FormData(this);
        const data = Object.fromEntries(currentFormData.entries());

        // compare the initial form data with the current form data
        if (JSON.stringify([...initialFormData]) === JSON.stringify([...currentFormData])) {
          
        // display a message to the user
        Swal.fire({
            title: "No changes!",
            text: "You have not made any changes to your profile.",
            icon: "info"
        });
        
    } 
    else{
        // update the initial form data
        initialFormData = new FormData(this);

        fetch('/app/user-update/', {
            method: 'PATCH',
            headers: {
                'Authorization': `Token ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          // check if the response body is empty
          if (response.headers.get('content-length') === '0') {
              // if the response body is empty, return an empty object
              return {};
          } else {
              // if the response body is not empty, parse it as JSON
              return response.json();
          }
      })
        .then(data => {
           console.log(data)
           
                // update the UI with the new data
                var elements = document.getElementsByClassName('username');
                for (var i = 0; i < elements.length; i++) {
                  elements[i].value = data.username;
              }
                document.getElementById('firstName').textContent = data.first_name;
                document.getElementById('lastName').textContent = data.last_name;
                document.getElementById('email').textContent = data.email;
                document.getElementById('phone').textContent = data.phone_number;
                document.getElementById('address').textContent = data.address; 
                document.getElementById('gender').value = data.gender;
    
                // display a success message
                Swal.fire({
                  icon: "success",
                  title: "Your profile has been updated",
                  showConfirmButton: false,
                  timer: 1500
                });
            
        })
        .catch(error => {
            // handle error
            console.error('There has been a problem with your fetch operation:', error);
            Swal.fire({
              icon: "An error occurred while updating the profile",
              title: "Oops...",
              text: "Something went wrong!",
              footer: '<a href=""stackoverflow.com>Why do I have this issue?</a>'
            });
        });
    }
    });

    document.getElementById('deleteAccountButton').addEventListener('click', function() {
      Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!"
      }).then((result) => {
          if (result.isConfirmed) {
              // get the username
              var username = document.getElementsByClassName('username')[0].value;
  
              // send a DELETE request to the server
              fetch(`/app/delete-user/${username}/`, {
                  method: 'DELETE',
                  headers: {
                    'Authorization': `Token ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
              })
              .then(response => {
                  if (response.ok) {
                      Swal.fire({
                          title: "Deleted!",
                          text: "Your account has been deleted.",
                          icon: "success"
                      });
                      window.location.href = '/';  // replace '/' with the URL of your home page
                  } else {
                      Swal.fire({
                          title: "Error!",
                          text: "There was an error deleting your account.",
                          icon: "error"
                      });
                  }
              });
          }
      });
  });
  function confirmLogout(event) {
    event.preventDefault();
    Swal.fire({
        title: 'Are you sure?',
  text: "Once logged out, you will need to log in again to access your account",
  icon: 'warning',
  showCancelButton: true,
  confirmButtonColor: '#3085d6',
  cancelButtonColor: '#d33',
  position:'bottom-start',
  confirmButtonText: 'Yes, logout!'
}).then((result) => {
  if (result.isConfirmed) {
      fetch('/api/auth/logout/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}' // assuming you have a getCookie function to get the CSRF token
          },
      })
      .then(response => {
          if (response.ok) {
              window.location.href = '/'; // redirect to login page after successful logout
          } else {
              Swal.fire('Error', 'Logout failed', 'error');
          }
      });
  }
})
}

document.getElementById('passwordChangeForm').addEventListener('submit', function(event) {

  // prevent form submission
  event.preventDefault();

  let passwordFormData = new FormData(this);
  let passwordData = Object.fromEntries(passwordFormData.entries());

   // check if new passwords match
   if (passwordData.new_password1 !== passwordData.new_password2) {
    Swal.fire({
        title: "Passwords do not match!",
        icon: "error"
    });
    return;
  }
    // rename the form data fields to match the names expected by the backend
    passwordData = {
      old_password: passwordData.old_password,
      password: passwordData.new_password1,
  };
  
  // send a POST request to your user-update/ API endpoint
  fetch('/app/user-update/', {
      method: 'PATCH',
      headers: {
          'Authorization': `Token ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json',
      },
      body: JSON.stringify(passwordData)
  }).then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    Swal.fire({
        title: "Password changed successfully!",
        icon: "success"
    });

    // Update the stored token with the new one
    localStorage.setItem('token', data.token);

     // clear the form fields
     this.reset();
  })
  .catch(error => {
    console.error('There has been a problem with your fetch operation:', error);
    Swal.fire({
        title: "Failed to change password!",
        icon: "error"
    });
  });
});
</script>
</html>